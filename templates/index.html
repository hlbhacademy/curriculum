<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>課表查詢系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold mb-2">課表查詢系統</h1>
    <p class="text-sm text-gray-500 mb-4">登入帳號：{{ email }}</p>

    <!-- 查詢區塊 -->
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <label class="font-semibold">查詢模式：</label>
      <label><input type="radio" name="mode" value="class" checked> 班級</label>
      <label><input type="radio" name="mode" value="teacher"> 教師</label>
      <label><input type="radio" name="mode" value="room"> 教室</label>

      <select id="target" class="ml-4 px-2 py-1 border rounded">
        {% for name in class_names %}
          <option value="{{ name }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- 課表標題含日期列 -->
    <div class="overflow-x-auto">
      <table class="w-full border text-center text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="w-20">節次</th>
            {% for day in range(1, 6) %}
              <th class="px-2 py-1">
                星期{{ '一二三四五'[day-1] }}<br />
                <span class="text-xs text-gray-500">
                  {{ weekday_dates.get(day, '') }}
                </span>
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody id="scheduleBody">
          {% for p in range(1, 9) %}
            <tr class="border-b">
              <td class="bg-gray-100 font-medium">第{{ p }}節</td>
              {% for d in range(1, 6) %}
                <td class="py-2 text-sm text-gray-700 bg-blue-50" id="cell-{{ d }}-{{ p }}"></td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <p class="text-xs text-gray-500 mt-4">
      課表資料最後更新於 {{ yesterday }} 16:00，今日最新課表仍以教學組發布為準
    </p>
  </div>

  <!-- JS 載入與互動邏輯 -->
  <script>
    async function loadSchedule() {
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const target = document.getElementById("target").value;
      const res = await fetch(`/schedule/${mode}/${target}`);
      const data = await res.json();

      // 清空
      for (let d = 1; d <= 5; d++) {
        for (let p = 1; p <= 8; p++) {
          document.getElementById(`cell-${d}-${p}`).innerHTML = "";
        }
      }

      // 填入課表
      for (const key in data) {
        const [d, p] = key.split("-");
        const content = `${data[key].subject}<br><span class='text-xs text-gray-500'>${data[key].teacher}</span>`;
        document.getElementById(`cell-${d}-${p}`).innerHTML = content;
      }
    }

    document.getElementById("target").addEventListener("change", loadSchedule);
    document.querySelectorAll('input[name="mode"]').forEach(radio => {
      radio.addEventListener("change", async () => {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const select = document.getElementById("target");
        select.innerHTML = "";

        const options = {
          "class": {{ class_names|tojson }},
          "teacher": {{ teacher_names|tojson }},
          "room": {{ room_names|tojson }}
        }[mode];

        options.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });

        await loadSchedule();
      });
    });

    // 初始載入
    window.onload = loadSchedule;
  </script>
</body>
</html>
