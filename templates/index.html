<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>èª²è¡¨æŸ¥è©¢ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            suggested: 'rgba(59, 130, 246, 0.2)',
            discouraged: 'rgba(251, 191, 36, 0.2)',
            origin: 'rgba(107, 114, 128, 0.2)',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="p-4 bg-primary text-white flex justify-between items-center shadow">
    <h1 class="text-lg font-semibold">ğŸŒ¸ èŠ±è“®é«˜å•†èª²è¡¨æŸ¥è©¢ç³»çµ±</h1>
    <div>
      æ‚¨å¥½ï¼Œ{{ email }}ï¼
      <a href="/logout" class="ml-4 border px-2 py-1 rounded hover:bg-white hover:text-primary transition">ç™»å‡º</a>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4">
    <div class="bg-white p-4 shadow rounded">
      <label class="font-semibold">ç­ç´šæŸ¥è©¢</label>
      <select id="classSelect" class="w-full border mt-1 p-2 rounded">
        <option selected disabled>è«‹é¸æ“‡</option>
        {% for name in class_names %}
        <option value="{{ name }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="bg-white p-4 shadow rounded">
      <label class="font-semibold">æ•™å¸«æŸ¥è©¢</label>
      <select id="teacherSelect" class="w-full border mt-1 p-2 rounded">
        <option selected disabled>è«‹é¸æ“‡</option>
        {% for name in teacher_names %}
        <option value="{{ name }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="bg-white p-4 shadow rounded">
      <label class="font-semibold">æ•™å®¤æŸ¥è©¢</label>
      <select id="roomSelect" class="w-full border mt-1 p-2 rounded">
        <option selected disabled>è«‹é¸æ“‡</option>
        {% for name in room_names %}
        <option value="{{ name }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="p-4">
    <div class="bg-white rounded shadow p-4">
      <h2 class="text-xl font-bold mb-2">èª²è¡¨é¡¯ç¤ºï¼ˆæ›´æ–°æ™‚é–“ï¼š{{ update_time }}ï¼‰</h2>
      <p class="text-sm text-gray-500 mb-4">è«‹å…ˆé¸æ“‡ç­ç´šã€æ•™å¸«æˆ–æ•™å®¤ä»¥æŸ¥çœ‹èª²è¡¨</p>
      <div class="overflow-x-auto">
        <table class="w-full border text-center" id="scheduleTable"></table>
      </div>
<p class="text-xs text-right text-gray-500 mt-2">
  æœ¬èª²è¡¨ç‚ºæ•™å¸«èª¿èª²æŸ¥è©¢åƒè€ƒï¼Œæœ€æ–°èª²è¡¨ä¾æ•™å­¸çµ„ç™¼å¸ƒç‚ºæº–
</p>
    </div>
  </div>

  <script>
    const scheduleTable = document.getElementById("scheduleTable")
    let currentTarget = null
    const weekdays = ["ç¯€æ¬¡", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”"]

    const drawTable = (data = {}) => {
      let html = "<tr>" + weekdays.map(day => `<th class='p-2 border bg-gray-100'>${day}</th>`).join('') + "</tr>"
      for (let i = 1; i <= 8; i++) {
        html += `<tr>`
        html += `<td class='border bg-gray-100 p-1'>ç¬¬${i}ç¯€</td>`
        for (let d = 1; d <= 5; d++) {
          const key = `${d}-${i}`
          const course = data[key]
          html += `<td class='border p-2 align-top cursor-pointer hover:bg-gray-50' data-key='${key}'>` +
            (course ? `${course.subject}<br><span class='text-xs text-gray-500'>${course.teacher}</span>` : "") +
            `</td>`
        }
        html += `</tr>`
      }
      scheduleTable.innerHTML = html

      scheduleTable.querySelectorAll("td[data-key]").forEach(cell => {
        cell.addEventListener("click", async () => {
          scheduleTable.querySelectorAll("td").forEach(td => td.classList.remove("border-blue-400", "border-dashed", "bg-suggested", "bg-discouraged", "bg-origin"))

          const [d, p] = cell.dataset.key.split("-").map(Number)
          currentTarget = { day: d, period: p }

          cell.classList.add("bg-origin")

          const mode = document.querySelector("select:valid").id.replace("Select", "")
          const target = document.querySelector("select:valid").value
          const res = await fetch("/swap-options", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mode, target, weekday: d, period: p })
          })
          const result = await res.json()
          result.forEach(opt => {
            const td = document.querySelector(`td[data-key='${opt.day}-${opt.period}']`)
            if (td) {
              if ((opt.period === 8 && opt.original_period <= 7) || (opt.original_period === 8 && opt.period <= 7)) {
                return // ç¦æ­¢å°èª¿
              }
              td.classList.add(opt.recommended ? "border-blue-400" : "border-yellow-400")
              td.classList.add(opt.recommended ? "bg-suggested" : "bg-discouraged")
              td.classList.add("border-2", "border-dashed")
              td.title = opt.reason || "å»ºè­°å°èª¿"
            }
          })
        })
      })
    }

    const fetchSchedule = async (mode, target) => {
      const res = await fetch(`/schedule/${mode}/${target}`)
      const json = await res.json()
      drawTable(json)
    }

    document.querySelectorAll("select").forEach(select => {
      select.addEventListener("change", e => {
        document.querySelectorAll("select").forEach(s => {
          if (s !== select) s.selectedIndex = 0
        })
        const mode = select.id.replace("Select", "")
        const target = select.value
        fetchSchedule(mode, target)
      })
    })
  </script>
</body>
</html>
